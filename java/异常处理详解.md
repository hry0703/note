# Java 异常处理详解

## 📚 目录

1. [异常处理基础概念](#异常处理基础概念)
2. [异常的分类](#异常的分类)
3. [try-catch-finally](#try-catch-finally)
4. [throws 和 throw](#throws-和-throw)
5. [自定义异常](#自定义异常)
6. [异常处理最佳实践](#异常处理最佳实践)
7. [常见异常类型](#常见异常类型)

---

## 异常处理基础概念

### 什么是异常？

**异常（Exception）**是程序运行时发生的错误或意外情况，它会中断程序的正常执行流程。

### 为什么需要异常处理？

- ✅ **程序健壮性**：避免程序因为错误而崩溃
- ✅ **错误信息**：提供清晰的错误信息，便于调试
- ✅ **优雅降级**：在错误发生时能够优雅地处理，而不是直接崩溃
- ✅ **资源管理**：确保资源（如文件、数据库连接）能够正确释放

### 异常处理的基本流程

```
正常执行
    ↓
发生异常？
    ↓ 是
捕获异常
    ↓
处理异常
    ↓
继续执行或终止
```

---

## 异常的分类

### Java 异常层次结构

```
Throwable（所有异常和错误的父类）
├── Error（错误，通常无法恢复）
│   ├── OutOfMemoryError
│   ├── StackOverflowError
│   └── ...
│
└── Exception（异常，可以处理）
    ├── RuntimeException（运行时异常，非检查异常）
    │   ├── NullPointerException
    │   ├── ArrayIndexOutOfBoundsException
    │   ├── IllegalArgumentException
    │   └── ...
    │
    └── 其他 Exception（检查异常，必须处理）
        ├── IOException
        ├── SQLException
        ├── ClassNotFoundException
        └── ...
```

### 检查异常 vs 非检查异常

#### 检查异常（Checked Exception）

- 必须使用 `try-catch` 或 `throws` 处理
- 编译时检查，不处理无法编译通过
- 通常是外部因素导致的（如文件不存在、网络错误）

**示例**：
```java
// IOException 是检查异常，必须处理
public void readFile() throws IOException {
    FileReader file = new FileReader("file.txt");
    // 必须处理 IOException
}
```

#### 非检查异常（Unchecked Exception）

- 可以不处理（但建议处理）
- 编译时不检查
- 通常是程序逻辑错误（如空指针、数组越界）

**示例**：
```java
// NullPointerException 是非检查异常，可以不处理
public void process(String str) {
    int length = str.length();  // 如果 str 为 null，会抛出异常
    // 可以不处理，但建议处理
}
```

---

## try-catch-finally

### 基本语法

```java
try {
    // 可能抛出异常的代码
} catch (异常类型1 e) {
    // 处理异常类型1
} catch (异常类型2 e) {
    // 处理异常类型2
} finally {
    // 无论是否发生异常都会执行的代码
}
```

### try 块

包含可能抛出异常的代码。

```java
try {
    int result = 10 / 0;  // 可能抛出 ArithmeticException
    System.out.println("结果：" + result);
} catch (ArithmeticException e) {
    System.out.println("除零错误：" + e.getMessage());
}
```

### catch 块

捕获并处理异常。可以有多个 catch 块，按顺序匹配。

```java
try {
    // 代码
} catch (ArithmeticException e) {
    // 处理算术异常
    System.out.println("算术错误：" + e.getMessage());
} catch (NullPointerException e) {
    // 处理空指针异常
    System.out.println("空指针错误：" + e.getMessage());
} catch (Exception e) {
    // 处理其他所有异常（必须放在最后）
    System.out.println("其他错误：" + e.getMessage());
}
```

**注意**：catch 块的顺序很重要，应该从具体到一般。

### finally 块

无论是否发生异常，finally 块中的代码都会执行。常用于资源清理。

```java
FileReader file = null;
try {
    file = new FileReader("file.txt");
    // 读取文件
} catch (IOException e) {
    System.out.println("文件读取错误：" + e.getMessage());
} finally {
    // 无论是否发生异常，都会执行
    if (file != null) {
        try {
            file.close();  // 关闭文件
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

### try-with-resources（Java 7+）

自动管理资源，不需要手动关闭。

```java
// ✅ 推荐：使用 try-with-resources
try (FileReader file = new FileReader("file.txt")) {
    // 读取文件
    // 文件会自动关闭，不需要 finally
} catch (IOException e) {
    System.out.println("文件读取错误：" + e.getMessage());
}
```

**支持 try-with-resources 的资源必须实现 `AutoCloseable` 接口**。

---

## throws 和 throw

### throws（声明异常）

在方法签名中声明可能抛出的异常，将异常传递给调用者处理。

```java
// 声明可能抛出 IOException
public void readFile() throws IOException {
    FileReader file = new FileReader("file.txt");
    // 如果发生 IOException，会传递给调用者
}

// 调用者必须处理
public void caller() {
    try {
        readFile();
    } catch (IOException e) {
        System.out.println("处理异常：" + e.getMessage());
    }
}
```

**可以声明多个异常**：
```java
public void process() throws IOException, SQLException {
    // 可能抛出多个异常
}
```

### throw（抛出异常）

主动抛出异常。

```java
public void checkAge(int age) {
    if (age < 0) {
        throw new IllegalArgumentException("年龄不能为负数");
    }
    if (age > 150) {
        throw new IllegalArgumentException("年龄不能超过 150");
    }
    System.out.println("年龄：" + age);
}
```

**抛出检查异常时，必须声明 throws**：
```java
public void process() throws IOException {
    if (someCondition) {
        throw new IOException("自定义错误信息");
    }
}
```

---

## 自定义异常

### 为什么需要自定义异常？

- ✅ **语义清晰**：使用有意义的异常名称，提高代码可读性
- ✅ **错误分类**：区分不同类型的业务错误
- ✅ **信息丰富**：可以添加额外的错误信息

### 创建自定义异常

#### 方式 1：继承 Exception（检查异常）

```java
// 自定义检查异常
public class InsufficientBalanceException extends Exception {
    // 无参构造方法
    public InsufficientBalanceException() {
        super();
    }
    
    // 带消息的构造方法
    public InsufficientBalanceException(String message) {
        super(message);
    }
    
    // 带消息和原因的构造方法
    public InsufficientBalanceException(String message, Throwable cause) {
        super(message, cause);
    }
}
```

**使用**：
```java
public void withdraw(double amount) throws InsufficientBalanceException {
    if (balance < amount) {
        throw new InsufficientBalanceException("余额不足，当前余额：" + balance);
    }
    balance -= amount;
}

// 调用者必须处理
public void caller() {
    try {
        withdraw(1000);
    } catch (InsufficientBalanceException e) {
        System.out.println("取款失败：" + e.getMessage());
    }
}
```

#### 方式 2：继承 RuntimeException（非检查异常）

```java
// 自定义非检查异常
public class InvalidInputException extends RuntimeException {
    public InvalidInputException() {
        super();
    }
    
    public InvalidInputException(String message) {
        super(message);
    }
    
    public InvalidInputException(String message, Throwable cause) {
        super(message, cause);
    }
}
```

**使用**：
```java
public void validate(String input) {
    if (input == null || input.trim().isEmpty()) {
        throw new InvalidInputException("输入不能为空");
    }
    // 可以不处理，但建议处理
}

// 调用者可以选择处理或不处理
public void caller() {
    try {
        validate("");
    } catch (InvalidInputException e) {
        System.out.println("验证失败：" + e.getMessage());
    }
}
```

### 自定义异常的最佳实践

#### 1. 命名规范

- 异常类名应该以 `Exception` 结尾
- 名称应该清晰表达异常的含义

```java
// ✅ 好的命名
public class UserNotFoundException extends Exception {}
public class InvalidPasswordException extends Exception {}
public class PaymentFailedException extends Exception {}

// ❌ 不好的命名
public class Error1 extends Exception {}
public class MyException extends Exception {}
```

#### 2. 提供有用的信息

```java
public class InsufficientBalanceException extends Exception {
    private double balance;
    private double requestedAmount;
    
    public InsufficientBalanceException(double balance, double requestedAmount) {
        super(String.format("余额不足：当前余额 %.2f，请求金额 %.2f", 
              balance, requestedAmount));
        this.balance = balance;
        this.requestedAmount = requestedAmount;
    }
    
    public double getBalance() {
        return balance;
    }
    
    public double getRequestedAmount() {
        return requestedAmount;
    }
}
```

#### 3. 选择合适的父类

- **业务异常**：继承 `Exception`（检查异常）
- **参数验证异常**：继承 `IllegalArgumentException`（非检查异常）
- **状态异常**：继承 `IllegalStateException`（非检查异常）

```java
// 业务异常（检查异常）
public class OrderNotFoundException extends Exception {}

// 参数验证异常（非检查异常）
public class InvalidEmailException extends IllegalArgumentException {}

// 状态异常（非检查异常）
public class OrderAlreadyPaidException extends IllegalStateException {}
```

---

## 异常处理最佳实践

### 1. 不要忽略异常

```java
// ❌ 不好：忽略异常
try {
    process();
} catch (Exception e) {
    // 什么都不做，异常被吞掉了
}

// ✅ 好：至少记录异常
try {
    process();
} catch (Exception e) {
    e.printStackTrace();  // 至少打印堆栈
    // 或者记录日志
    logger.error("处理失败", e);
}
```

### 2. 使用具体的异常类型

```java
// ❌ 不好：捕获所有异常
try {
    process();
} catch (Exception e) {
    // 太宽泛
}

// ✅ 好：捕获具体的异常
try {
    process();
} catch (FileNotFoundException e) {
    // 处理文件不存在
} catch (IOException e) {
    // 处理其他 IO 错误
}
```

### 3. 不要在 finally 中返回

```java
// ❌ 不好：finally 中的 return 会覆盖 try 中的 return
public int test() {
    try {
        return 1;
    } finally {
        return 2;  // 总是返回 2
    }
}

// ✅ 好：不要在 finally 中返回
public int test() {
    int result = 0;
    try {
        result = 1;
    } finally {
        // 清理资源
    }
    return result;
}
```

### 4. 使用 try-with-resources

```java
// ❌ 不好：手动管理资源
FileReader file = null;
try {
    file = new FileReader("file.txt");
    // 读取
} finally {
    if (file != null) {
        file.close();
    }
}

// ✅ 好：自动管理资源
try (FileReader file = new FileReader("file.txt")) {
    // 读取
    // 自动关闭
}
```

### 5. 异常信息要清晰

```java
// ❌ 不好：异常信息不清晰
throw new Exception("错误");

// ✅ 好：异常信息清晰
throw new IllegalArgumentException("年龄不能为负数，当前值：" + age);
```

### 6. 不要过度使用异常

```java
// ❌ 不好：用异常控制流程
try {
    while (true) {
        list.get(index++);
    }
} catch (IndexOutOfBoundsException e) {
    // 结束循环
}

// ✅ 好：正常控制流程
while (index < list.size()) {
    list.get(index++);
}
```

---

## 常见异常类型

### RuntimeException（运行时异常）

#### NullPointerException（空指针异常）

```java
String str = null;
int length = str.length();  // 抛出 NullPointerException

// 处理
try {
    int length = str.length();
} catch (NullPointerException e) {
    System.out.println("字符串为空");
}

// 预防
if (str != null) {
    int length = str.length();
}
```

#### ArrayIndexOutOfBoundsException（数组越界异常）

```java
int[] array = {1, 2, 3};
int value = array[5];  // 抛出 ArrayIndexOutOfBoundsException

// 处理
try {
    int value = array[5];
} catch (ArrayIndexOutOfBoundsException e) {
    System.out.println("数组索引越界");
}

// 预防
if (index >= 0 && index < array.length) {
    int value = array[index];
}
```

#### IllegalArgumentException（非法参数异常）

```java
public void setAge(int age) {
    if (age < 0) {
        throw new IllegalArgumentException("年龄不能为负数");
    }
    this.age = age;
}
```

#### ClassCastException（类型转换异常）

```java
Object obj = "字符串";
Integer num = (Integer) obj;  // 抛出 ClassCastException

// 处理
try {
    Integer num = (Integer) obj;
} catch (ClassCastException e) {
    System.out.println("类型转换失败");
}

// 预防
if (obj instanceof Integer) {
    Integer num = (Integer) obj;
}
```

### 检查异常

#### IOException（IO 异常）

```java
try {
    FileReader file = new FileReader("file.txt");
    // 读取文件
} catch (IOException e) {
    System.out.println("文件操作失败：" + e.getMessage());
}
```

#### FileNotFoundException（文件未找到异常）

```java
try {
    FileReader file = new FileReader("file.txt");
} catch (FileNotFoundException e) {
    System.out.println("文件不存在：" + e.getMessage());
}
```

#### SQLException（SQL 异常）

```java
try {
    // 数据库操作
} catch (SQLException e) {
    System.out.println("数据库操作失败：" + e.getMessage());
}
```

---

## 📝 总结

### 异常处理要点

1. **try-catch-finally**：捕获和处理异常
2. **throws**：声明可能抛出的异常
3. **throw**：主动抛出异常
4. **自定义异常**：创建有意义的异常类

### 选择异常类型

- **检查异常**：外部因素导致的错误（文件、网络、数据库）
- **非检查异常**：程序逻辑错误（空指针、数组越界、参数错误）

### 最佳实践

- ✅ 不要忽略异常
- ✅ 使用具体的异常类型
- ✅ 使用 try-with-resources 管理资源
- ✅ 异常信息要清晰
- ✅ 不要用异常控制流程

---

*最后更新：2024年*
