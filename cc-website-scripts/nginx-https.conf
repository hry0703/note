# ========================================
# HTTP æœåŠ¡å™¨ - è‡ªåŠ¨è·³è½¬åˆ° HTTPS
# ========================================
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;  # ğŸ‘ˆ ä¿®æ”¹ä¸ºæ‚¨çš„åŸŸå
    
    # å¼ºåˆ¶é‡å®šå‘åˆ° HTTPS
    return 301 https://$server_name$request_uri;
}

# ========================================
# HTTPS æœåŠ¡å™¨ - ä¸»é…ç½®
# ========================================
server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;  # ğŸ‘ˆ ä¿®æ”¹ä¸ºæ‚¨çš„åŸŸå
    
    root /usr/share/nginx/html;
    index index.html;
    
    # ========================================
    # SSL è¯ä¹¦é…ç½®
    # ========================================
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;
    
    # SSL åè®®å’ŒåŠ å¯†å¥—ä»¶
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    
    # SSL ä¼šè¯ç¼“å­˜
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;
    
    # OCSP Stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;
    
    # ========================================
    # å®‰å…¨å¤´éƒ¨é…ç½®
    # ========================================
    # HSTS (å¼ºåˆ¶ HTTPSï¼Œæœ‰æ•ˆæœŸ1å¹´)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    
    # é˜²æ­¢ç‚¹å‡»åŠ«æŒ
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # XSS ä¿æŠ¤
    add_header X-XSS-Protection "1; mode=block" always;
    
    # é˜²æ­¢ MIME ç±»å‹å—…æ¢
    add_header X-Content-Type-Options "nosniff" always;
    
    # Referrer ç­–ç•¥
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    
    # CSP å†…å®¹å®‰å…¨ç­–ç•¥ï¼ˆå¯æ ¹æ®éœ€è¦è°ƒæ•´ï¼‰
    # add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
    
    # ========================================
    # 1. è®¾å¤‡æ£€æµ‹
    # ========================================
    set $mobile_request 0;
    
    # æ£€æµ‹ç§»åŠ¨è®¾å¤‡ User-Agent
    if ($http_user_agent ~* "(Mobile|Android|iPhone|iPad|iPod|BlackBerry|Windows Phone|Opera Mini)") {
        set $mobile_request 1;
    }
    
    # ========================================
    # 2. é™æ€èµ„æºå¤„ç†ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
    # ========================================
    
    # PCç«¯é™æ€èµ„æº
    location /assets/ {
        try_files $uri =404;
        # é™æ€èµ„æºç¼“å­˜
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # H5ç«¯é™æ€èµ„æº
    location /assets-h5/ {
        try_files $uri =404;
        # é™æ€èµ„æºç¼“å­˜
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # faviconå¤„ç†
    location /favicon.ico {
        try_files $uri /mobile/favicon.ico /pc/favicon.ico =404;
        access_log off;
        log_not_found off;
    }
    
    # ========================================
    # 3. æ ¹è·¯å¾„ - è®¾å¤‡ç±»å‹è·¯ç”±åˆ†å‘
    # ========================================
    location = / {
        if ($mobile_request = 1) {
            rewrite ^ /mobile/index.html last;
        }
        rewrite ^ /pc/index.html last;
    }
    
    # ========================================
    # 4. PCç«¯é¡¹ç›®ï¼ˆæ”¯æŒå‰ç«¯è·¯ç”±ï¼‰
    # ========================================
    location /pc/ {
        try_files $uri $uri/ /pc/index.html;
    }
    
    # ========================================
    # 5. H5ç§»åŠ¨ç«¯é¡¹ç›®ï¼ˆæ”¯æŒå‰ç«¯è·¯ç”±ï¼‰
    # ========================================
    location /mobile/ {
        try_files $uri $uri/ /mobile/index.html;
    }
    
    # ========================================
    # 6. å…œåº•è·¯ç”± - å¤„ç†æ‰€æœ‰å…¶ä»–å‰ç«¯è·¯ç”±è¯·æ±‚
    # ========================================
    location / {
        # æ ¹æ®è®¾å¤‡ç±»å‹è¿”å›å¯¹åº”çš„index.html
        if ($mobile_request = 1) {
            rewrite ^ /mobile/index.html last;
        }
        rewrite ^ /pc/index.html last;
    }
    
    # ========================================
    # 7. ç¼“å­˜æ§åˆ¶ï¼ˆHTMLæ–‡ä»¶ä¸ç¼“å­˜ï¼‰
    # ========================================
    location ~* \.(html)$ {
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate";
        add_header Pragma "no-cache";
    }
    
    # ========================================
    # 8. Gzip å‹ç¼©é…ç½®
    # ========================================
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
    
    # ========================================
    # 9. æ—¥å¿—é…ç½®
    # ========================================
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
}

